@model IEnumerable<AspnetCoreMvcFull.Models.ArsipSurat>

@{
  ViewData["Title"] = "Arsip Surat";
  @* ViewData["isNavbar"] = false;
  ViewData["navbarType"] = "layout-navbar-hidden"; *@
}

@{
  var message = TempData["SuccessMessage"] as string;

  if (message != null)
  {
    TempData.Remove("SuccessMessage");
  }
}

@section PageStyles {
  <link rel="stylesheet" href="~/vendor/libs/toastify/toastify.min.css">
}

<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item">
      <a href="@Url.Action("Index", "ArsipSurat")">Arsip Surat</a>
    </li>
    <li class="breadcrumb-item active" aria-current="page">
      Home
    </li>
  </ol>
</nav>

<div class="card">
  <div class="card-header">
    <p class="mb-0">Berikut ini adalah surat-surat yang telah terbit dan diarsipkan.</p>
    <p class="mb-0">Klik "Lihat" pada kolom aksi untuk menampilkan surat.</p>
  </div>
  <div class="card-body">
    <div class="row mb-3">
      <div class="col-md-5">
        <form asp-action="Index" method="get" class="d-flex">
          <div class="input-group">
            <input type="text" class="form-control" name="searchQuery" value="@ViewData["CurrentFilter"]"
              placeholder="Cari surat..." aria-label="Cari surat">
            <button class="btn btn-outline-primary" type="submit">Cari!</button>
          </div>
        </form>
      </div>
    </div>

    <div class="table-responsive text-nowrap">
      <table class="table table-bordered">
        <thead>
          <tr>
            <th>Nomor Surat</th>
            <th>Kategori</th>
            <th>Judul</th>
            <th>Waktu Pengarsipan</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody class="table-border-bottom-0">
          @if (Model.Any())
          {
            foreach (var item in Model)
            {
              <tr>
                <td><strong>@item.NomorSurat</strong></td>
                <td>@item.KategoriSurat.NamaKategori</td>
                <td>@item.Judul</td>
                <td>@item.WaktuPengarsipan.ToLocalTime().ToString("yyyy-MM-dd HH:mm")</td>
                <td>
                  <div class="d-flex align-items-center">
                    <button type="button" class="btn btn-danger btn-sm me-2" style="width: 60px;" data-bs-toggle="modal"
                      data-bs-target="#deleteModal" data-id="@item.Id" data-judul="@item.Judul">
                      Hapus
                    </button>

                    <a class="btn btn-warning btn-sm me-2" style="width: 60px;" asp-action="Download"
                      asp-route-id="@item.Id">Unduh</a>

                    <a class="btn btn-info btn-sm" style="width: 60px;" asp-action="Detail"
                      asp-route-id="@item.Id">Lihat</a>
                  </div>
                </td>
              </tr>
            }
          }
          else
          {
            <tr>
              <td colspan="5" class="text-center">Tidak ada data untuk ditampilkan.</td>
            </tr>
          }
        </tbody>
      </table>
    </div>

    <div class="mt-5">
      <a class="btn btn-primary" asp-action="Create">Arsipkan Surat</a>
    </div>
  </div>
</div>

<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title w-100 text-center" id="modalCenterTitle">Konfirmasi Hapus</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <p>Apakah Anda yakin ingin menghapus data ini?</p>
        <p><strong><span id="judulSuratToDelete"></span></strong></p>
      </div>
      <div class="modal-footer justify-content-center">
        <button type="button" class="btn btn-outline-secondary me-2" data-bs-dismiss="modal"
          style="width: 120px;">Batal</button>
        <form id="deleteForm" asp-action="Delete" method="post">
          @Html.AntiForgeryToken()
          <input type="hidden" id="recordIdToDelete" name="id" />
          <button type="submit" class="btn btn-danger" style="width: 120px;">Ya, Hapus!</button>
        </form>
      </div>
    </div>
  </div>
</div>

@section PageScripts {
  <script src="~/vendor/libs/toastify/toastify-js.js"></script>
  <script>
    function showToast(message, type = 'success') {
      const title = type === 'success' ? 'Berhasil!' : 'Gagal!';
      Toastify({
        text: `${title} ${message}`,
        duration: 3000,
        close: true,
        gravity: 'top',
        position: 'right',
        stopOnFocus: true,
        style: {
          background: type === 'success' ? '#198754' : '#dc3545',
          borderRadius: '0.5rem',
        },
      }).showToast();
    }

    var successMessage = "@message";

    if (successMessage) {
      showToast(successMessage, 'success');
    }

    // Script untuk menangani modal konfirmasi hapus
    var deleteModal = document.getElementById('deleteModal');
    deleteModal.addEventListener('show.bs.modal', function (event) {
      // Tombol yang memicu modal
      var button = event.relatedTarget;

      // Ekstrak info dari atribut data-*
      var recordId = button.getAttribute('data-id');
      var judulSurat = button.getAttribute('data-judul');

      // Perbarui konten modal
      var modalJudul = deleteModal.querySelector('#judulSuratToDelete');
      var deleteForm = deleteModal.querySelector('#deleteForm');
      var recordIdInput = deleteModal.querySelector('#recordIdToDelete');

      modalJudul.textContent = judulSurat;
      recordIdInput.value = recordId;

      // Atur action form secara dinamis (meskipun sudah di-handle oleh asp-action, ini lebih eksplisit)
      // Anda bisa hapus baris ini jika asp-action sudah cukup
      deleteForm.action = '/ArsipSurat/Delete/' + recordId;
    });
  </script>
}
